# 2.4 デプロイ

アジャイル開発における、DevOps 的なアプローチでいえば、「デプロイ/リリース」と「テスト」や「デプロイ/リリース」と「保守・運用」の距離感は非常に近くなるはずだが、現時点ではそうなっていない。

慣習や契約の制限、責任分界点の問題など多くの問題があるが、ここではまずデプロイ/リリースそのものに関わる課題を記載する。

前述の通りデプロイ/リリースは、テストにより高められた品質を評価し、保守・運用フェーズに橋渡しする最終のクオリティゲートであり、サービス・プロダクトに対する評価の正当性を確保することが求められる。また、万が一サービス・プロダクトの欠陥が顕在化し、価値提供に重大な支障が発生した場合、安全な状態に切り戻しを行う手段が確立されていることが求められる。

また、デプロイ/リリースの一連のプロセス自体が、効率化・高速化することでサービス・プロダクトの改善における価値提供を早めることができるため、安全性のみならずコスト面や顧客満足度の向上にも資することとなる。

本章では、デプロイ/リリースに対する要求事項に対し、どのような課題が存在するかを述べた上で、それらを解決するためにどのような取り組みがあるかを後述する。

## 目次

- [2.4 デプロイ](#24-デプロイ)
  - [目次](#目次)
  - [1. デプロイ対象の状態把握に関する課題](#1-デプロイ対象の状態把握に関する課題)
    - [課題](#課題)
    - [解決方針](#解決方針)
  - [2. クオリティゲートにおける判断材料に関する課題](#2-クオリティゲートにおける判断材料に関する課題)
    - [課題](#課題-1)
    - [解決方針](#解決方針-1)
  - [3. セキュリティ対策に関する課題](#3-セキュリティ対策に関する課題)
    - [課題](#課題-2)
    - [解決方針](#解決方針-2)
    - [ベストプラクティス（例）](#ベストプラクティス例)
  - [4. 安全かつ迅速なリカバリープランを実現する切替方式に関する課題](#4-安全かつ迅速なリカバリープランを実現する切替方式に関する課題)
    - [課題](#課題-3)
    - [解決方針](#解決方針-3)

---

## 1. デプロイ対象の状態把握に関する課題

### 課題

- 評価するサービス・プロダクトに対し、以下の状態を対象物（リポジトリ）から透過的に把握することができず、品質確保状況の妥当性を正しく評価できず、クオリティゲートとして機能できない要因となり得る。
  - 定められたテストが全て実施されている
  - 各テスト項目が必要十分に行われた妥当性が検証されている

### 解決方針

- 評価対象サービス・プロダクトに対するテストやテスト結果の妥当性検証等の各プロセスが、対象物（リポジトリ）と突き合わせて横並びで確認できる必要がある。
- そのため、以下のようにテスト工程ごとに評価対象物のコンポーネントと対になるプロセスをテンプレートとして定め、オールグリーンであることを視覚的に認識しやすい形式を採用すべきである。
  - 総合テスト
    要件に対するテスト実施状況と妥当性評価結果
  - 結合テスト
    サービス（プログラムの集合体）に対するテスト実施状況と妥当性評価結果
  - 単体テスト
    プログラムに対するテスト実施状況と妥当性評価結果

## 2. クオリティゲートにおける判断材料に関する課題

### 課題

- デプロイ対象のサービス・プロダクトを出荷する際の最終のクオリティゲートとして、品質確保状況の妥当性を正しく評価する必要がある。しかし、組織として取り決められた稼働条件に係る評価基準や判断根拠、稼働判断に係る最低稼働条件やエマージェンシープランが一様に取り揃えられていない。そのため、サービス・プロダクトがプロジェクト別に整備することになり、一様なクオリティゲートとして機能できず、サービス・プロダクトの品質レベルにばらつきが生じる要因となる。

### 解決方針

- クオリティゲートとして一様に機能するために、以下の判断材料を整備する。
  - 稼働条件に係る品質確保状況の評価基準
  - 評価基準に対する判断根拠
  - 最低稼働条件
  - エマージェンシープラン

## 3. セキュリティ対策に関する課題

### 課題

- システムに対するセキュリティ対策は、要件定義～設計～開発～テストと、各段階から具備していく必要があるが、日々巧妙化しているセキュリティ攻撃に対して、常時対策が施されているかを確認していく必要がある。
- しかし、セキュリティ対策は往々にして最終工程近くでの脆弱性診断で妥当性を検証することが多く、脆弱性の検出に対する手戻りや品質コストが発生してしまう課題がある。
- また、開発速度が高いアジャイル手法でプロダクトを構築する場合、膨大なコストを有する脆弱性診断に頼らず、クイックに検出しスピーディーに解決する仕組みの導入が必要である。

### 解決方針

- CI/CD プロセスにセキュアコーディングに対する診断プロセスを自動的に組み込み、サイクリックにセキュリティ対策状況の評価・検出をする。

### ベストプラクティス（例）

- Jenkins Pipeline により以下の CI/CD プロセスを自動的に実行し、DevSecOps を実現

  1. CI/CD 環境上の構成管理 Gitlab より日次で最新ソースをチェックアウト \
     ※ 脆弱性診断プロセスは週 1 回のチェックアウト
  2. マイクロサービスごとに実行アプリケーションをビルド
  3. 静的解析ツールを用いたコードディング評価 \
     ※ ツール例：コード品質評価（Coverity）、脆弱性診断（FortifySCA）
  4. テストコードの自動実行（Junit/Selenium）
  5. テストコード実行結果をカバレッジ取得し、Sonar Qube 等でカバレッジレポート収集
  6. カバレッジレポートでの定量評価(自動)および人間系でコード静的解析結果/脆弱性診断結果を判定しアプリケーション実装の妥当性を確認
  7. リポジトリやレジストリに対し、デプロイ対象イメージを登録
  8. 検証環境にてステージングの評価を実施し、人間系にて本番リリース前の最終確認
  9. 本番環境へデプロイ

  図：Jenkins pipeline による CI/CD プロセス
  
  ![vJbUAV3](https://user-images.githubusercontent.com/72844688/128278431-22cd4809-2d4b-40e5-b2c0-47711fe411de.png)

## 4. 安全かつ迅速なリカバリープランを実現する切替方式に関する課題

### 課題

- 万が一サービス・プロダクトの欠陥が顕在化し、価値提供に重大な支障が発生した場合、安全な状態への切り戻しを迅速に行う必要があるが、多くのシステムはモノリシックなシステム構造であることから、リカバリーに必要な手順が多く、ミス等による二次災害の懸念もあり、提供する価値が大幅に損なわれる可能性がリスクがある。

### 解決方針

- システム実装設計段階で、切替方式を策定する。採用するデプロイ方式は、手法（Method）、戦略（Strategy）、対象（Target）の組合せにて、サービス・プロダクトの欠陥が与える影響度で判断する。

  - デプロイ手法（Method）
    各サーバーに対してどのようにデプロイを行っていくか
    | 名称 | デプロイ先 | ダウンタイム |
    | -------- | -------- | -------- |
    | サービス停止 & デプロイ | 稼働中サーバー | 閉塞期間 |
    | シンボリックリンク切り替え | 稼働中サーバー | ほぼゼロ（最大で再起動時間）|
    | インプレースデプロイ | 稼働中サーバー | デプロイ＋再起動時間 |
    | ブルー/グリーンデプロイ | 新しいサーバー | ほぼゼロ |
    | イミュータブルデプロイ | 新しいサーバー | ほぼゼロ |

  - デプロイ戦略（Strategy）
    複数サーバーに対してどのような順でリリースするか

    | 名称               | デプロイ先         | ダウンタイム           |
    | ------------------ | ------------------ | ---------------------- |
    | ローリングデプロイ | ブロック単位で実施 | ゼロ                   |
    | 一括デプロイ       | 全台まとめて実施   | （デプロイ手法に依存） |

  - デプロイ対象（Target）
    複数サーバーに対してどのような順でリリースするか

    | 名称             | デプロイ先   | ダウンタイム                 |
    | ---------------- | ------------ | ---------------------------- |
    | カナリアデプロイ | 一定台数のみ | ゼロ                         |
    | 一括デプロイ     | 全台         | （デプロイ戦略、手法に依存） |
